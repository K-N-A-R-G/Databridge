# ETL Module (`etl.py`)

This module provides functions to extract, transform, and load tabular data into **pandas DataFrames** using JSON templates generated by **MetaEditor**.

---

## Purpose
- Read structured/semi-structured files (CSV/JSON) and convert them into a consistent DataFrame format.
- Apply column-level normalization rules (types, formats, header case).
- Append new files into an existing DataFrame while filtering out invalid rows.
- Optionally handle duplicate rows during concatenation via `drop_duplicates`.

---

## Functions

### `create_df_from_file(file_path: Path, template: dict, drop_duplicates: bool = False) -> pd.DataFrame`
Creates a DataFrame from a file according to the column specification in `template`.

- Reads raw data using `getdata.read_data`.
- Builds a dictionary of target columns (only those with `"save": true`).
- Normalizes each value with `normalize_column` (type casting, formatting, case adjustment).
- Returns a cleaned DataFrame.
- Optionally removes duplicate rows if `drop_duplicates=True`.

⚠️ **Limitations:**
- Each value is normalized independently; cross-row logic (like duplicate detection) is applied only if `drop_duplicates=True`.
- Invalid or unconvertible values are set to `None`.

---

### `append_df_from_file(df: pd.DataFrame, file_path: Path, template: dict, drop_duplicates: bool = False) -> pd.DataFrame`
Appends rows from another file to the existing DataFrame.

- Creates a DataFrame from the new file using `create_df_from_file`.
- Drops rows where all values are `None`.
- Concatenates with the existing DataFrame.
- Optionally removes duplicate rows if `drop_duplicates=True`.

> Use this function when aggregating multiple sources of the same structure.

---

### `load_template(template_path: Path) -> dict`
Loads a JSON template created by **MetaEditor**.

- Returns a Python `dict`.
- Template defines:
  - Source column name → target name
  - Type and format rules
  - Optional flags (`save`, `header_case`)

---

## Reasons for Cleaning/Normalization
- Missing values → converted to `None` for consistency.
- Different date/number formats.
- Case inconsistencies in headers.
- Rows with no valid data.
- **Duplicates:**
  - Sometimes duplicates are meaningful (e.g., identical sales events or log entries).
  - Sometimes they indicate noise.
  - Decision is left to the user via the `drop_duplicates` parameter.

---

## Example

```python
from pathlib import Path
import pandas as pd
from etl import load_template, create_df_from_file, append_df_from_file

template = load_template(Path("template.json"))

df = create_df_from_file(Path("file1.json"), template)
df = append_df_from_file(df, Path("file2.json"), template, drop_duplicates=True)

print(df.head())
